<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Write a JavaScript Parser in Rust Blog</title>
        <link>https://boshen.github.io/javascript-parser-in-rust/ja/blog</link>
        <description>Write a JavaScript Parser in Rust Blog</description>
        <lastBuildDate>Fri, 21 Jul 2023 06:45:25 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>ja</language>
        <item>
            <title><![CDATA[Rome Tools]]></title>
            <link>https://boshen.github.io/javascript-parser-in-rust/ja/blog/rome</link>
            <guid>/rome</guid>
            <pubDate>Fri, 21 Jul 2023 06:45:25 GMT</pubDate>
            <description><![CDATA[Rome uses a different set of techniques for parsing JavaScript and TypeScript.]]></description>
            <content:encoded><![CDATA[<p><a href="https://github.com/rome/tools" target="_blank" rel="noopener noreferrer">Rome</a> uses a different set of techniques for parsing JavaScript and TypeScript.
This tutorial summarizes them in learning order for better understanding.</p><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="history">History<a class="hash-link" href="#history" title="この見出しへのリンク">​</a></h2><ul><li>The Rome codebase was rewritten from TypeScript to Rust, see <a href="https://rome.tools/blog/2021/09/21/rome-will-be-rewritten-in-rust" target="_blank" rel="noopener noreferrer">Rome will be rewritten in Rust</a></li><li>The decision was made after talking to the author of <a href="https://github.com/rslint/rslint" target="_blank" rel="noopener noreferrer">rslint</a> and <a href="https://github.com/rust-lang/rust-analyzer" target="_blank" rel="noopener noreferrer">rust-analyzer</a></li><li>rust-analyzer proved that IDE-centric tools built around concrete syntax tree are possible</li><li>rslint proved that it is possible to write a JavaScript parser in Rust, with the same base libraries as rust-analyzer</li><li>Rome ported the rslint codebase to their own repo with permission from rslint's author</li></ul><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="concrete-syntax-tree">Concrete Syntax Tree<a class="hash-link" href="#concrete-syntax-tree" title="この見出しへのリンク">​</a></h2><ul><li>The base library is called <a href="https://github.com/rust-analyzer/rowan" target="_blank" rel="noopener noreferrer">rowan</a>, see <a href="https://github.com/rust-lang/rust-analyzer/blob/master/docs/dev/syntax.md" target="_blank" rel="noopener noreferrer">overview of rowan</a></li><li>Rowan, also known as red-green trees, is named after the real green <a href="https://en.wikipedia.org/wiki/Rowan" target="_blank" rel="noopener noreferrer">rowan tree</a> that makes red berries</li><li>The origin of red-green trees is described in this <a href="https://ericlippert.com/2012/06/08/red-green-trees/" target="_blank" rel="noopener noreferrer">blog post</a>, by the authors of the C# programming language</li><li>The whole point of rowan is to define a lossless concrete syntax tree (CST) that describes all the details of the source code and provides a set of traversal APIs (parent, children, siblings, etc)</li><li>Read the advantage of having a CST over an AST: <a href="https://rdambrosio016.github.io/rust/2020/09/18/pure-ast-based-linting-sucks.html" target="_blank" rel="noopener noreferrer">Pure AST based linting sucks</a></li><li>CST provides the ability to build a fully recoverable parser</li></ul><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="grammar">Grammar<a class="hash-link" href="#grammar" title="この見出しへのリンク">​</a></h2><ul><li>Just like an AST, we need to define the grammar. The grammar is auto-generated by using <a href="https://github.com/rome/tools/tree/main/xtask/codegen" target="_blank" rel="noopener noreferrer">xtask/codegen</a></li><li>The grammar is generated from the <a href="https://github.com/rust-analyzer/ungrammar" target="_blank" rel="noopener noreferrer">ungrammar</a> DSL</li><li>The input <code>ungrammar</code> source file is in <a href="https://github.com/rome/tools/blob/main/xtask/codegen/js.ungram" target="_blank" rel="noopener noreferrer">xtask/codegen/js.ungram</a></li><li>The output of the codegen is in <a href="https://github.com/rome/tools/tree/main/crates/rome_js_syntax/src/generated" target="_blank" rel="noopener noreferrer">rome_js_syntax/src/generated</a></li></ul><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="entry-point">Entry Point<a class="hash-link" href="#entry-point" title="この見出しへのリンク">​</a></h2><p>The Rome codebase is getting large and slightly difficult to find the parser entry point.</p><p>For first-time contributors, the <code>rome_cli</code> crate is the binary entry point for running the code:</p><div class="language-bash codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-bash codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">cargo run -p rome_cli</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">touch</span><span class="token plain"> test.js</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cargo run -p rome_cli -- check ./test.js</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>rome_cli</code> will eventually call <code>rome_js_parser::parse</code></p><div><div class="language-rust codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_t9t_">crates/rome_js_parser/src/parse.rs</div><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-rust codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">loading</span><span class="token punctuation" style="color:rgb(248, 248, 242)">...</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div style="font-size:.9em;font-weight:600;color:#0E75DD;text-align:center;padding-bottom:13px;text-decoration:underline"><a href="https://github.com/rome/tools/blob/9815467c66688773bc1bb6ef9a5b2d86ca7b3682/crates/rome_js_parser/src/parse.rs#L178-L187" target="_blank">See full example on GitHub</a></div></div><p>and finally the actual parsing code</p><div><div class="language-rust codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_t9t_">crates/rome_js_parser/src/syntax/program.rs</div><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-rust codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">loading</span><span class="token punctuation" style="color:rgb(248, 248, 242)">...</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div style="font-size:.9em;font-weight:600;color:#0E75DD;text-align:center;padding-bottom:13px;text-decoration:underline"><a href="https://github.com/rome/tools/blob/9815467c66688773bc1bb6ef9a5b2d86ca7b3682/crates/rome_js_parser/src/syntax/program.rs#L14-L17" target="_blank">See full example on GitHub</a></div></div><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="contributing">Contributing<a class="hash-link" href="#contributing" title="この見出しへのリンク">​</a></h2><ul><li><a href="https://github.com/rome/tools/blob/main/CONTRIBUTING.md" target="_blank" rel="noopener noreferrer">CONTRIBUTING.md</a> has instructions on how to contribute</li><li><a href="https://rome.github.io/tools/rome_js_parser/index.html" target="_blank" rel="noopener noreferrer">rome_js_parser crate doc</a> has some more details on the parser</li><li>See <a href="https://github.com/rome/tools/tree/main/xtask/codegen#cargo-codegen-test" target="_blank" rel="noopener noreferrer"><code>cargo codegen test</code></a> for working with parser tests</li><li>See <a href="https://github.com/rome/tools/tree/main/xtask/coverage" target="_blank" rel="noopener noreferrer"><code>cargo coverage</code></a> for working with conformance tests</li><li>Join the <a href="https://discord.com/invite/rome" target="_blank" rel="noopener noreferrer">Discord Server</a> for inquiries</li></ul><div class="theme-admonition theme-admonition-info alert alert--info admonition_uPsx"><div class="admonitionHeading_iLYZ"><span class="admonitionIcon_Ci8g"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>備考</div><div class="admonitionContent_zKpZ"><p>The JavaScript / TypeScript parser is 99% complete, the best way to help is to test Rome in your own codebases
or take a look at the <a href="https://github.com/rome/tools/issues" target="_blank" rel="noopener noreferrer">issues on Github</a>.</p></div></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Grammar]]></title>
            <link>https://boshen.github.io/javascript-parser-in-rust/ja/blog/grammar</link>
            <guid>/grammar</guid>
            <pubDate>Fri, 21 Jul 2023 06:45:25 GMT</pubDate>
            <description><![CDATA[JavaScript has one of the most challenging grammar to parse,]]></description>
            <content:encoded><![CDATA[<p>JavaScript has one of the most challenging grammar to parse,
this tutorial details all the sweat and tears I had while learning it.</p><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="ll1-grammar">LL(1) Grammar<a class="hash-link" href="#ll1-grammar" title="この見出しへのリンク">​</a></h2><p>According to <a href="https://en.wikipedia.org/wiki/LL_grammar" target="_blank" rel="noopener noreferrer">Wikipedia</a>,</p><blockquote><p>an LL grammar is a context-free grammar that can be parsed by an LL parser, which parses the input from Left to right</p></blockquote><p>The first <strong>L</strong> means the scanning the source from <strong>L</strong>eft to right,
and the second <strong>L</strong> means the construction of a <strong>L</strong>eftmost derivation tree.</p><p>Context-free and the (1) in LL(1) means a tree can be constructed by just peeking at the next token and nothing else.</p><p>LL Grammars are of particular interest in academia because we are lazy human beings and we want to write programs that generate parsers automatically so we don't need to write parsers by hand.</p><p>Unfortunately, most industrial programming languages do not have a nice LL(1) grammar,
and this applies to JavaScript too.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_uPsx"><div class="admonitionHeading_iLYZ"><span class="admonitionIcon_Ci8g"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>備考</div><div class="admonitionContent_zKpZ"><p>Mozilla started the <a href="https://github.com/mozilla-spidermonkey/jsparagus" target="_blank" rel="noopener noreferrer">jsparagus</a> project a few years ago
and wrote a <a href="https://github.com/mozilla-spidermonkey/jsparagus/tree/master/jsparagus" target="_blank" rel="noopener noreferrer">LALR parser generator in Python</a>.
They haven't updated it much in the past two years and they sent a strong message at the end of <a href="https://github.com/mozilla-spidermonkey/jsparagus/blob/master/js-quirks.md" target="_blank" rel="noopener noreferrer">js-quirks.md</a></p><blockquote><p>What have we learned today?</p><ul><li>Do not write a JS parser.</li><li>JavaScript has some syntactic horrors in it. But hey, you don't make the world's most widely used programming language by avoiding all mistakes. You do it by shipping a serviceable tool, in the right circumstances, for the right users.</li></ul></blockquote></div></div><hr><p>The only practical way to parse JavaScript is to write a recursive descent parser by hand because of the nature of its grammar,
so let's learn all the quirks in the grammar before we shoot ourselves in the foot.</p><p>The list below starts simple and will become difficult to grasp,
so please take grab a coffee and take your time.</p><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="identifiers">Identifiers<a class="hash-link" href="#identifiers" title="この見出しへのリンク">​</a></h2><p>There are three types of identifiers defined in <code>#sec-identifiers</code>,</p><div class="language-markup codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-markup codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">IdentifierReference[Yield, Await] :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">BindingIdentifier[Yield, Await] :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">LabelIdentifier[Yield, Await] :</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>estree</code> and some ASTs do not distinguish the above identifiers,
and the specification does not explain them in plain text.</p><p><code>BindingIdentifier</code>s are declarations and <code>IdentifierReference</code>s are references to binding identifiers.
For example in <code>var foo = bar</code>, <code>foo</code> is a <code>BindingIdentifier</code> and <code>bar</code> is a <code>IdentifierReference</code> in the grammar:</p><div class="language-markup codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-markup codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">VariableDeclaration[In, Yield, Await] :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    BindingIdentifier[?Yield, ?Await] Initializer[?In, ?Yield, ?Await] opt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Initializer[In, Yield, Await] :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    = AssignmentExpression[?In, ?Yield, ?Await]</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>follow <code>AssignmentExpression</code> into <code>PrimaryExpression</code> we get</p><div class="language-markup codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-markup codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">PrimaryExpression[Yield, Await] :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    IdentifierReference[?Yield, ?Await]</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Declaring these identifiers differently in the AST will greatly simply downstream tools, especially for semantic analysis.</p><div class="language-rust codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-rust codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pub</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">struct</span><span class="token plain"> </span><span class="token type-definition class-name">BindingIdentifier</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pub</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pub</span><span class="token plain"> name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">Atom</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pub</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">struct</span><span class="token plain"> </span><span class="token type-definition class-name">IdentifierReference</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pub</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pub</span><span class="token plain"> name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">Atom</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><hr><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="class-and-strict-mode">Class and Strict Mode<a class="hash-link" href="#class-and-strict-mode" title="この見出しへのリンク">​</a></h2><p>ECMAScript Class is born after strict mode, so they decided that everything inside a class must be strict mode for simplicity.
It is stated as such in <code>#sec-class-definitions</code> with just a <code>Node: A class definition is always strict mode code.</code></p><p>It is easy to declare strict mode by associating it with function scopes, but a <code>class</code> declaration does not have a scope,
we need to keep an extra state just for parsing classes.</p><div><div class="language-rust codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_t9t_">crates/swc_ecma_parser/src/parser/class_and_fn.rs</div><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-rust codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">loading</span><span class="token punctuation" style="color:rgb(248, 248, 242)">...</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div style="font-size:.9em;font-weight:600;color:#0E75DD;text-align:center;padding-bottom:13px;text-decoration:underline"><a href="https://github.com/swc-project/swc/blob/f9c4eff94a133fa497778328fa0734aa22d5697c/crates/swc_ecma_parser/src/parser/class_and_fn.rs#L85" target="_blank">See full example on GitHub</a></div></div><hr><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="legacy-octal-and-use-strict">Legacy Octal and Use Strict<a class="hash-link" href="#legacy-octal-and-use-strict" title="この見出しへのリンク">​</a></h2><p><code>#sec-string-literals-early-errors</code> disallows escaped legacy octal inside strings <code>"\01"</code>:</p><div class="language-markup codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-markup codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">EscapeSequence ::</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    LegacyOctalEscapeSequence</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    NonOctalDecimalEscapeSequence</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">It is a Syntax Error if the source text matched by this production is strict mode code.</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The best place to detect this is inside the lexer, it can ask the parser for strict mode state and throw errors accordingly.</p><p>But, this becomes impossible when mixed with directives:</p><div><div class="language-javascript codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_t9t_">test/language/literals/string/legacy-octal-escape-sequence-prologue-strict.js</div><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-javascript codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">loading</span><span class="token spread operator">...</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div style="font-size:.9em;font-weight:600;color:#0E75DD;text-align:center;padding-bottom:13px;text-decoration:underline"><a href="https://github.com/tc39/test262/blob/747bed2e8aaafe8fdf2c65e8a10dd7ae64f66c47/test/language/literals/string/legacy-octal-escape-sequence-prologue-strict.js#L16-L19" target="_blank">See full example on GitHub</a></div></div><p><code>use strict</code> is declared after the escaped legacy octal, yet the syntax error needs to be thrown.
Fortunately, no real code uses directives with legacy octals ... unless you want to pass the test262 case from above.</p><hr><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="non-simple-parameter-and-strict-mode">Non-simple Parameter and Strict Mode<a class="hash-link" href="#non-simple-parameter-and-strict-mode" title="この見出しへのリンク">​</a></h2><p>Identical function parameters is allowed in non-strict mode <code>function foo(a, a) { }</code>,
and we can forbid this by adding <code>use strict</code>: <code>function foo(a, a) { "use strict" }</code>.
Later on in es6, other grammars were added to function parameters, for example <code>function foo({ a }, b = c) {}</code>.</p><p>Now, what happens if we write the following where "01" is a strict mode error?</p><div class="language-javaScript codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-javaScript codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">function foo(value=(function() { return "\01" }())) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    "use strict";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return value;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>More specifically, what should we do if there is a strict mode syntax error inside the parameters thinking from the parser perspective?
So in <code>#sec-function-definitions-static-semantics-early-errors</code>, it just bans this by stating</p><div class="language-markup codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-markup codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">FunctionDeclaration :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">FunctionExpression :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">It is a Syntax Error if FunctionBodyContainsUseStrict of FunctionBody is true and IsSimpleParameterList of FormalParameters is false.</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Chrome throws this error with a mysterious message "Uncaught SyntaxError: Illegal 'use strict' directive in function with non-simple parameter list".</p><p>A more in-depth explanation is described in <a href="https://humanwhocodes.com/blog/2016/10/the-ecmascript-2016-change-you-probably-dont-know/" target="_blank" rel="noopener noreferrer">this blog post</a> by the author of ESLint.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_uPsx"><div class="admonitionHeading_iLYZ"><span class="admonitionIcon_Ci8g"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>備考</div><div class="admonitionContent_zKpZ"><p>Fun fact, the above rule does not apply if we are targeting <code>es5</code> in TypeScript, it transpiles to</p><div class="language-javaScript codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-javaScript codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">function foo(a, b) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    "use strict";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if (b === void 0) { b = "\01"; }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div><hr><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="parenthesized-expression">Parenthesized Expression<a class="hash-link" href="#parenthesized-expression" title="この見出しへのリンク">​</a></h2><p>Parenthesized expressions are supposed to not have any semantic meanings?
For instance the AST for <code>((x))</code> can just be a single <code>IdentifierReference</code>, not <code>ParenthesizedExpression</code> -&gt; <code>ParenthesizedExpression</code> -&gt; <code>IdentifierReference</code>.
And this is the case for JavaScript grammar.</p><p>But ... who would have thought it can have run-time meanings.
Found in <a href="https://github.com/estree/estree/issues/194" target="_blank" rel="noopener noreferrer">this estree issue</a>, it shows that</p><div class="language-javascript codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-javascript codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token function-variable function" style="color:rgb(80, 250, 123)">fn</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">&gt;</span><span class="token plain"> fn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"fn"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">fn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">&gt;</span><span class="token plain"> fn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">''</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>So eventually acorn and babel added the <code>preserveParens</code> option for compatibility.</p><hr><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="function-declaration-in-if-statement">Function Declaration in If Statement<a class="hash-link" href="#function-declaration-in-if-statement" title="この見出しへのリンク">​</a></h2><p>If we follow the grammar precisely in <code>#sec-ecmascript-language-statements-and-declarations</code>:</p><div class="language-markup codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-markup codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Statement[Yield, Await, Return] :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ... lots of statements</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Declaration[Yield, Await] :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ... declarations</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>Statement</code> node we define for our AST would obviously not contain <code>Declaration</code>,</p><p>but in Annex B <code>#sec-functiondeclarations-in-ifstatement-statement-clauses</code>,
it allows declaration inside the statement position of <code>if</code> statements in non-strict mode:</p><div class="language-javascript codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-javascript codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">foo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">bar</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><hr><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="label-statement-is-legit">Label statement is legit<a class="hash-link" href="#label-statement-is-legit" title="この見出しへのリンク">​</a></h2><p>We probably have never written a single line of labelled statement, but it is legit in modern JavaScript and not banned by strict mode.</p><p>The following syntax is correct, it returns a labelled statement (not object literal).</p><div class="language-javascript codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-javascript codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token operator">&lt;</span><span class="token maybe-class-name">Foo</span><span class="token plain"> bar</span><span class="token operator">=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token literal-property property">baz</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'quaz'</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">             </span><span class="token comment" style="color:rgb(98, 114, 164)">//   ^^^^^^^^^^^ `LabelledStatement`</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><hr><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="let-is-not-a-keyword"><code>let</code> is not a keyword<a class="hash-link" href="#let-is-not-a-keyword" title="この見出しへのリンク">​</a></h2><p><code>let</code> is not a keyword so it is allowed to appear anywhere unless the grammar explicitly states <code>let</code> is not allowed in such positions.
Parsers need to peek at the token after the <code>let</code> token and decide what it needs to be parsed into, e.g.:</p><div class="language-javascript codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-javascript codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> a</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> foo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">instanceof</span><span class="token plain"> </span><span class="token class-name">x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">a </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><hr><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="for-in--for-of-and-the-in-context">For-in / For-of and the <!-- -->[In]<!-- --> context<a class="hash-link" href="#for-in--for-of-and-the-in-context" title="この見出しへのリンク">​</a></h2><p>If we look at the grammar for <code>for-in</code> and <code>for-of</code> in <code>#prod-ForInOfStatement</code>,
it is immediately confusing to understand how to parse these.</p><p>There are two major obstacles for us to understand: the <code>[lookahead ≠ let]</code> part and the <code>[+In]</code> part.</p><p>If we have parsed to <code>for (let</code>, we need to check the peeking token is:</p><ul><li>not <code>in</code> to disallow <code>for (let in)</code></li><li>is <code>{</code>, <code>[</code> or an identifier to allow <code>for (let {} = foo)</code>, <code>for (let [] = foo)</code> and <code>for (let bar = foo)</code></li></ul><p>Once reached the <code>of</code> or <code>in</code> keyword, the right-hand side expression needs to be passed with the correct <!-- -->[+In]<!-- --> context to disallow
the two <code>in</code> expressions in <code>#prod-RelationalExpression</code>:</p><div class="codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-text codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">RelationalExpression[In, Yield, Await] :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    [+In] RelationalExpression[+In, ?Yield, ?Await] in ShiftExpression[?Yield, ?Await]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    [+In] PrivateIdentifier in ShiftExpression[?Yield, ?Await]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Note 2: The [In] grammar parameter is needed to avoid confusing the in operator in a relational expression with the in operator in a for statement.</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And this is the only application for the <code>[In]</code> context in the entire specification.</p><p>Also to note, the grammar <code>[lookahead ∉ { let, async of }]</code> forbids <code>for (async of ...)</code>,
and it needs to be explicitly guarded against.</p><hr><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="block-level-function-declarations">Block-Level Function Declarations<a class="hash-link" href="#block-level-function-declarations" title="この見出しへのリンク">​</a></h2><p>In Annex B.3.2 <code>#sec-block-level-function-declarations-web-legacy-compatibility-semantics</code>,
an entire page is dedicated to explain how <code>FunctionDeclaration</code> is supposed to behave in <code>Block</code> statements.
It boils down to</p><div><div class="language-javascript codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_t9t_">acorn/src/scope.js</div><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-javascript codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">loading</span><span class="token spread operator">...</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div style="font-size:.9em;font-weight:600;color:#0E75DD;text-align:center;padding-bottom:13px;text-decoration:underline"><a href="https://github.com/acornjs/acorn/blob/11735729c4ebe590e406f952059813f250a4cbd1/acorn/src/scope.js#L30-L35" target="_blank">See full example on GitHub</a></div></div><p>The name of a <code>FunctionDeclaration</code> needs to be treated the same as a <code>var</code> declaration if its inside a function declaration.
This code snippet errors with a re-declaration error since <code>bar</code> is inside a block scope:</p><div class="language-javascript codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-javascript codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">foo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> bar</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">bar</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// redeclaration error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>meanwhile, the following does not error because it is inside a function scope, function <code>bar</code> is treated as a var declaration:</p><div class="language-javascript codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-javascript codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">foo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> bar</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">bar</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><hr><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="grammar-context">Grammar Context<a class="hash-link" href="#grammar-context" title="この見出しへのリンク">​</a></h2><p>The syntactic grammar has 5 context parameters for allowing and disallowing certain constructs,
namely <code>[In]</code>, <code>[Return]</code>, <code>[Yield]</code>, <code>[Await]</code> and <code>[Default]</code>.</p><p>It is best to keep a context during parsing, for example in Rome:</p><div><div class="language-rust codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_t9t_">crates/rome_js_parser/src/state.rs</div><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-rust codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">loading</span><span class="token punctuation" style="color:rgb(248, 248, 242)">...</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div style="font-size:.9em;font-weight:600;color:#0E75DD;text-align:center;padding-bottom:13px;text-decoration:underline"><a href="https://github.com/rome/tools/blob/5a059c0413baf1d54436ac0c149a829f0dfd1f4d/crates/rome_js_parser/src/state.rs#L404-L425" target="_blank">See full example on GitHub</a></div></div><p>And toggle and check these flags accordingly by following the grammar.</p><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="assignmentpattern-vs-bindingpattern">AssignmentPattern vs BindingPattern<a class="hash-link" href="#assignmentpattern-vs-bindingpattern" title="この見出しへのリンク">​</a></h2><p>In <code>estree</code>, the left-hand side of an <code>AssignmentExpression</code> is a <code>Pattern</code>:</p><div class="language-markup codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-markup codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">extend interface AssignmentExpression {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    left: Pattern;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and the left-hand side of a <code>VariableDeclarator</code> is a <code>Pattern</code>:</p><div class="language-markup codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-markup codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">interface VariableDeclarator &lt;: Node {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    type: "VariableDeclarator";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    id: Pattern;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    init: Expression | null;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>A <code>Pattern</code> can be a <code>Identifier</code>, <code>ObjectPattern</code>, <code>ArrayPattern</code>:</p><div class="language-markup codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-markup codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">interface Identifier &lt;: Expression, Pattern {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    type: "Identifier";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    name: string;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">interface ObjectPattern &lt;: Pattern {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    type: "ObjectPattern";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    properties: [ AssignmentProperty ];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">interface ArrayPattern &lt;: Pattern {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    type: "ArrayPattern";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    elements: [ Pattern | null ];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>But from the specification perspective, we have the following JavaScript:</p><div class="language-javascript codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-javascript codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// AssignmentExpression:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> foo </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> bar</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token plain"> </span><span class="token maybe-class-name">IdentifierReference</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"> foo </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> bar</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token plain"> </span><span class="token maybe-class-name">IdentifierReference</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// VariableDeclarator</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> foo </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> bar</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token plain"> </span><span class="token maybe-class-name">BindingIdentifier</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"> foo </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> bar</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token plain"> </span><span class="token maybe-class-name">BindingIdentifier</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This starts to become confusing because we now have a situation where we cannot directly distinguish whether the <code>Identifier</code> is a <code>BindingIdentifier</code> or a <code>IdentifierReference</code>
inside a <code>Pattern</code>:</p><div class="language-rust codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-rust codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">enum</span><span class="token plain"> </span><span class="token type-definition class-name">Pattern</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">Identifier</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// Is this a `BindingIdentifier` or a `IdentifierReference`?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">ArrayPattern</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">ObjectPattern</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This will lead to all sorts of unnecessary code further down the parser pipeline.
For example, when setting up the scope for semantic analysis, we need to inspect the parents of this <code>Identifier</code>
to determine whether we should bind it to the scope or not.</p><p>A better solution is to fully understand the specification and decide what to do.</p><p>The grammar for <code>AssignmentExpression</code> and <code>VariableDeclaration</code> are defined as:</p><div class="language-marup codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-marup codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">13.15 Assignment Operators</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">AssignmentExpression[In, Yield, Await] :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    LeftHandSideExpression[?Yield, ?Await] = AssignmentExpression[?In, ?Yield, ?Await]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">13.15.5 Destructuring Assignment</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">In certain circumstances when processing an instance of the production</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">AssignmentExpression : LeftHandSideExpression = AssignmentExpression</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">the interpretation of LeftHandSideExpression is refined using the following grammar:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">AssignmentPattern[Yield, Await] :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ObjectAssignmentPattern[?Yield, ?Await]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ArrayAssignmentPattern[?Yield, ?Await]</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-markup codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-markup codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">14.3.2 Variable Statement</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">VariableDeclaration[In, Yield, Await] :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    BindingIdentifier[?Yield, ?Await] Initializer[?In, ?Yield, ?Await]opt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    BindingPattern[?Yield, ?Await] Initializer[?In, ?Yield, ?Await]</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The specification distinguishes this two grammar by defining them separately with an <code>AssignmentPattern</code> and a <code>BindingPattern</code>.</p><p>So in situations like this, do not be afraid to deviate from <code>estree</code> and define extra AST nodes for our parser:</p><div class="language-rust codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-rust codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">enum</span><span class="token plain"> </span><span class="token type-definition class-name">BindingPattern</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">BindingIdentifier</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">ObjectBindingPattern</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">ArrayBindingPattern</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">enum</span><span class="token plain"> </span><span class="token type-definition class-name">AssignmentPattern</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">IdentifierReference</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">ObjectAssignmentPattern</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">ArrayAssignmentPattern</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I was in a super confusing state for a whole week until I finally reached enlightenment:
we need to define an <code>AssignmentPattern</code> node and a <code>BindingPattern</code> node instead of a single <code>Pattern</code> node.</p><ul><li><code>estree</code> must be correct because people have been using it for years so it cannot be wrong?</li><li>how are we going to cleanly distinguish the <code>Identifier</code>s inside the patterns without defining two separate nodes?
I just cannot find where the grammar is?</li><li>After a whole day of navigating the specification ...
the grammar for <code>AssignmentPattern</code> is in the 5th subsection of the main section "13.15 Assignment Operators" with the subtitle "Supplemental Syntax" 🤯 -
this is really out of place because all grammar is defined in the main section, not like this one defined after the "Runtime Semantics" section</li></ul><hr><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_uPsx"><div class="admonitionHeading_iLYZ"><span class="admonitionIcon_Ci8g"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_zKpZ"><p>The following cases are really difficult to grasp. Here be dragons.</p></div></div><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="ambiguous-grammar">Ambiguous Grammar<a class="hash-link" href="#ambiguous-grammar" title="この見出しへのリンク">​</a></h2><p>Let's first think like a parser and solve the problem - given the <code>/</code> token, is it a division operator or the start of a regex expression?</p><div class="language-javascript codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-javascript codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">a </span><span class="token operator">/</span><span class="token plain"> b</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">a </span><span class="token operator">/</span><span class="token plain"> </span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex"> regex </span><span class="token regex regex-delimiter">/</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">a </span><span class="token operator">/=</span><span class="token plain"> </span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex"> regex </span><span class="token regex regex-delimiter">/</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">/</span><span class="token plain"> regex </span><span class="token operator">/</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> b</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">/=</span><span class="token operator">/</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">=</span><span class="token regex regex-delimiter">/</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It is almost impossible, isn't it? Let's break these down and follow the grammar.</p><p>The first thing we need to understand is that the syntactic grammar drives the lexical grammar as stated in <code>#sec-ecmascript-language-lexical-grammar</code></p><blockquote><p>There are several situations where the identification of lexical input elements is sensitive to the syntactic grammar context that is consuming the input elements.</p></blockquote><p>This means that the parser is responsible for telling the lexer which token to return next.
The above example indicates that the lexer needs to return either a <code>/</code> token or a <code>RegExp</code> token.
For getting the correct <code>/</code> or <code>RegExp</code> token, the specification says:</p><blockquote><p>The InputElementRegExp goal symbol is used in all syntactic grammar contexts where a RegularExpressionLiteral is permitted ...
In all other contexts, InputElementDiv is used as the lexical goal symbol.</p></blockquote><p>And the syntax for <code>InputElementDiv</code> and <code>InputElementRegExp</code> are</p><div class="language-markup codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-markup codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">InputElementDiv ::</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    WhiteSpace</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    LineTerminator</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Comment</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    CommonToken</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    DivPunctuator &lt;---------- the `/` and `/=` token</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    RightBracePunctuator</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">InputElementRegExp ::</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    WhiteSpace</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    LineTerminator</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Comment</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    CommonToken</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    RightBracePunctuator</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    RegularExpressionLiteral &lt;-------- the `RegExp` token</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This means whenever the grammar reaches <code>RegularExpressionLiteral</code>, <code>/</code> need to be tokenized as a <code>RegExp</code> token (and throw an error if it does not have a matching <code>/</code>).
All other cases we'll tokenize <code>/</code> as a slash token.</p><p>Let's walk through an example:</p><div class="codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-text codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">a / / regex /</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">^ ------------ PrimaryExpression:: IdentifierReference</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ^ ---------- MultiplicativeExpression: MultiplicativeExpression MultiplicativeOperator ExponentiationExpression</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ^^^^^^^^ - PrimaryExpression: RegularExpressionLiteral</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This statement does not match any other start of <code>Statement</code>,
so it'll go down the <code>ExpressionStatement</code> route:</p><p><code>ExpressionStatement</code> --&gt; <code>Expression</code> --&gt; <code>AssignmentExpression</code> --&gt; ... --&gt;
<code>MultiplicativeExpression</code> --&gt; ... --&gt;
<code>MemberExpression</code> --&gt; <code>PrimaryExpression</code> --&gt; <code>IdentifierReference</code>.</p><p>We stopped at <code>IdentifierReference</code> and not <code>RegularExpressionLiteral</code>,
the statement "In all other contexts, InputElementDiv is used as the lexical goal symbol" applies.
The first slash is a <code>DivPunctuator</code> token.</p><p>Since this is a <code>DivPunctuator</code> token,
the grammar <code>MultiplicativeExpression: MultiplicativeExpression MultiplicativeOperator ExponentiationExpression</code> is matched,
the right-hand side is expected to be an <code>ExponentiationExpression</code>.</p><p>Now we are at the second slash in <code>a / /</code>.
By following <code>ExponentiationExpression</code>,
we reach <code>PrimaryExpression: RegularExpressionLiteral</code> because <code>RegularExpressionLiteral</code> is the only matching grammar with a <code>/</code>:</p><div class="language-markup codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-markup codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">RegularExpressionLiteral ::</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    / RegularExpressionBody / RegularExpressionFlags</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This second <code>/</code> will be tokenized as <code>RegExp</code> because
the specification states "The InputElementRegExp goal symbol is used in all syntactic grammar contexts where a RegularExpressionLiteral is permitted".</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_uPsx"><div class="admonitionHeading_iLYZ"><span class="admonitionIcon_Ci8g"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>備考</div><div class="admonitionContent_zKpZ"><p>As an exercise, try and follow the grammar for <code>/=/ / /=/</code>.</p></div></div><hr><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="cover-grammar">Cover Grammar<a class="hash-link" href="#cover-grammar" title="この見出しへのリンク">​</a></h2><p>Read the <a href="https://v8.dev/blog/understanding-ecmascript-part-4" target="_blank" rel="noopener noreferrer">V8 blog post</a> on this topic first.</p><p>To summarize, the specification states the following three cover grammars:</p><h4 class="anchor anchorWithStickyNavbar_lLJQ" id="coverparenthesizedexpressionandarrowparameterlist">CoverParenthesizedExpressionAndArrowParameterList<a class="hash-link" href="#coverparenthesizedexpressionandarrowparameterlist" title="この見出しへのリンク">​</a></h4><div class="language-markup codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-markup codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">PrimaryExpression[Yield, Await] :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    CoverParenthesizedExpressionAndArrowParameterList[?Yield, ?Await]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">When processing an instance of the production</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">PrimaryExpression[Yield, Await] : CoverParenthesizedExpressionAndArrowParameterList[?Yield, ?Await]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    the interpretation of CoverParenthesizedExpressionAndArrowParameterList is refined using the following grammar:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ParenthesizedExpression[Yield, Await] :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ( Expression[+In, ?Yield, ?Await] )</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-markup codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-markup codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">ArrowFunction[In, Yield, Await] :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ArrowParameters[?Yield, ?Await] [no LineTerminator here] =&gt; ConciseBody[?In]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ArrowParameters[Yield, Await] :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    BindingIdentifier[?Yield, ?Await]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    CoverParenthesizedExpressionAndArrowParameterList[?Yield, ?Await]</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>These definitions defines:</p><div class="language-javascript codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-javascript codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> foo </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">a</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// SequenceExpression</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> </span><span class="token function-variable function" style="color:rgb(80, 250, 123)">bar</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">a</span><span class="token parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token parameter"> b</span><span class="token parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token parameter"> c</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// ArrowExpression</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token plain"> </span><span class="token maybe-class-name">CoverParenthesizedExpressionAndArrowParameterList</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>A simple but cumbersome approach to solving this problem is to parse it as a <code>Vec&lt;Expression&gt;</code> first,
then write a converter function to convert it to <code>ArrowParameters</code> node, i.e. each individual <code>Expression</code> need to be converted to a <code>BindingPattern</code>.</p><p>It should be noted that, if we are building the scope tree within the parser,
i.e. create the scope for arrow expression during parsing,
but do not create one for a sequence expression,
it is not obvious how to do this. <a href="https://github.com/evanw/esbuild" target="_blank" rel="noopener noreferrer">esbuild</a> solved this problem by creating a temporary scope first,
and then dropping it if it is not an <code>ArrowExpression</code>.</p><p>This is stated in its <a href="https://github.com/evanw/esbuild/blob/master/docs/architecture.md#symbols-and-scopes" target="_blank" rel="noopener noreferrer">architecture document</a>:</p><blockquote><p>This is mostly pretty straightforward except for a few places where the parser has pushed a scope and is in the middle of parsing a declaration only to discover that it's not a declaration after all. This happens in TypeScript when a function is forward-declared without a body, and in JavaScript when it's ambiguous whether a parenthesized expression is an arrow function or not until we reach the =&gt; token afterwards. This would be solved by doing three passes instead of two so we finish parsing before starting to set up scopes and declare symbols, but we're trying to do this in just two passes. So instead we call popAndDiscardScope() or popAndFlattenScope() instead of popScope() to modify the scope tree later if our assumptions turn out to be incorrect.</p></blockquote><hr><h4 class="anchor anchorWithStickyNavbar_lLJQ" id="covercallexpressionandasyncarrowhead">CoverCallExpressionAndAsyncArrowHead<a class="hash-link" href="#covercallexpressionandasyncarrowhead" title="この見出しへのリンク">​</a></h4><div class="language-markup codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-markup codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">CallExpression :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    CoverCallExpressionAndAsyncArrowHead</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">When processing an instance of the production</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CallExpression : CoverCallExpressionAndAsyncArrowHead</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">the interpretation of CoverCallExpressionAndAsyncArrowHead is refined using the following grammar:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CallMemberExpression[Yield, Await] :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    MemberExpression[?Yield, ?Await] Arguments[?Yield, ?Await]</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-markup codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-markup codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">AsyncArrowFunction[In, Yield, Await] :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    CoverCallExpressionAndAsyncArrowHead[?Yield, ?Await] [no LineTerminator here] =&gt; AsyncConciseBody[?In]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CoverCallExpressionAndAsyncArrowHead[Yield, Await] :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    MemberExpression[?Yield, ?Await] Arguments[?Yield, ?Await]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">When processing an instance of the production</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">AsyncArrowFunction : CoverCallExpressionAndAsyncArrowHead =&gt; AsyncConciseBody</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">the interpretation of CoverCallExpressionAndAsyncArrowHead is refined using the following grammar:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">AsyncArrowHead :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    async [no LineTerminator here] ArrowFormalParameters[~Yield, +Await]</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>These definitions define:</p><div class="language-javascript codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-javascript codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">async</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">a</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// CallExpression</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">async</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">a</span><span class="token parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token parameter"> b</span><span class="token parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token parameter"> c</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// AsyncArrowFunction</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token plain"> </span><span class="token maybe-class-name">CoverCallExpressionAndAsyncArrowHead</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This looks strange because <code>async</code> is not a keyword. The first <code>async</code> is a function name.</p><hr><h4 class="anchor anchorWithStickyNavbar_lLJQ" id="coverinitializedname">CoverInitializedName<a class="hash-link" href="#coverinitializedname" title="この見出しへのリンク">​</a></h4><div class="language-markup codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-markup codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">13.2.5 Object Initializer</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ObjectLiteral[Yield, Await] :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">PropertyDefinition[Yield, Await] :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    CoverInitializedName[?Yield, ?Await]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Note 3: In certain contexts, ObjectLiteral is used as a cover grammar for a more restricted secondary grammar.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">The CoverInitializedName production is necessary to fully cover these secondary grammars. However, use of this production results in an early Syntax Error in normal contexts where an actual ObjectLiteral is expected.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">13.2.5.1 Static Semantics: Early Errors</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">In addition to describing an actual object initializer the ObjectLiteral productions are also used as a cover grammar for ObjectAssignmentPattern and may be recognized as part of a CoverParenthesizedExpressionAndArrowParameterList. When ObjectLiteral appears in a context where ObjectAssignmentPattern is required the following Early Error rules are not applied. In addition, they are not applied when initially parsing a CoverParenthesizedExpressionAndArrowParameterList or CoverCallExpressionAndAsyncArrowHead.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">PropertyDefinition : CoverInitializedName</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    I* t is a Syntax Error if any source text is matched by this production.</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-makrup codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-makrup codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">13.15.1 Static Semantics: Early Errors</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">AssignmentExpression : LeftHandSideExpression = AssignmentExpression</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">If LeftHandSideExpression is an ObjectLiteral or an ArrayLiteral, the following Early Error rules are applied:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    * LeftHandSideExpression must cover an AssignmentPattern.</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>These definitions define:</p><div class="language-javascript codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-javascript codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> prop </span><span class="token operator">=</span><span class="token plain"> value </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// ObjectAssignmentPattern</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> prop </span><span class="token operator">=</span><span class="token plain"> value </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// ObjectLiteral with SyntaxError</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Parsers need to parse <code>ObjectLiteral</code> with <code>CoverInitializedName</code>,
and throw the syntax error if it does not reach <code>=</code> for <code>ObjectAssignmentPattern</code>.</p><p>As an exercise, which one of the following <code>=</code> should throw a syntax error?</p><div class="language-javascript codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-javascript codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> x </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> x </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> x </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[The ECMAScript Specification]]></title>
            <link>https://boshen.github.io/javascript-parser-in-rust/ja/blog/ecma-spec</link>
            <guid>/ecma-spec</guid>
            <pubDate>Fri, 21 Jul 2023 06:45:25 GMT</pubDate>
            <description><![CDATA[The ECMAScript® 2023 Language Specification details everything about the JavaScript language, so anyone can implement their own JavaScript engine.]]></description>
            <content:encoded><![CDATA[<p><a href="https://tc39.es/ecma262/" target="_blank" rel="noopener noreferrer">The ECMAScript® 2023 Language Specification</a> details everything about the JavaScript language, so anyone can implement their own JavaScript engine.</p><p>The following chapters need to be studied for our parser:</p><ul><li>Chapter 5: Notational Conventions</li><li>Chapter 11: ECMAScript Language: Source Text</li><li>Chapter 12: ECMAScript Language: Lexical Grammar</li><li>Chapter 13 - 16: Expressions, Statements, Functions, Classes, Scripts and Modules</li><li>Annex B: Additional ECMAScript Features for Web Browsers</li><li>Annex C: The Strict Mode of ECMAScript</li></ul><p>For navigation inside the specification:</p><ul><li>Anything clickable has a permanent link, they are shown on the URL as anchors, for example <code>#sec-identifiers</code></li><li>Hovering over things may show a tooltip, clicking on <code>References</code> shows all its references</li></ul><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="notational-conventions">Notational Conventions<a class="hash-link" href="#notational-conventions" title="この見出しへのリンク">​</a></h2><p><a href="https://tc39.es/ecma262/#sec-grammar-notation" target="_blank" rel="noopener noreferrer">Chapter 5.1.5 Grammar Notation</a> is the section we need to read.</p><p>The things to note here are:</p><h3 class="anchor anchorWithStickyNavbar_lLJQ" id="recursion">Recursion<a class="hash-link" href="#recursion" title="この見出しへのリンク">​</a></h3><p>This is how lists are presented in the grammar.</p><div class="language-markup codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-markup codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">ArgumentList :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  AssignmentExpression</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ArgumentList , AssignmentExpression</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>means</p><div class="language-javascript codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-javascript codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">a</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> b </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> c </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">^</span><span class="token plain">_____________</span><span class="token operator">^</span><span class="token plain"> </span><span class="token maybe-class-name">ArgumentList</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><span class="token operator">^</span><span class="token plain">__________</span><span class="token operator">^</span><span class="token plain"> </span><span class="token maybe-class-name">ArgumentList</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token maybe-class-name">AssignmentExpression</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token operator">^</span><span class="token plain">___</span><span class="token operator">^</span><span class="token plain"> </span><span class="token maybe-class-name">AssignmentExpression</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_lLJQ" id="optional">Optional<a class="hash-link" href="#optional" title="この見出しへのリンク">​</a></h3><p>The <code>_opt_</code> suffix for optional syntax. For example,</p><div class="language-markup codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-markup codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">VariableDeclaration :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  BindingIdentifier Initializer_opt</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>means</p><div class="language-javascript codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-javascript codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> binding_identifier</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> binding_identifier </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">Initializer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       ______________ </span><span class="token maybe-class-name">Initializer_opt</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_lLJQ" id="parameters">Parameters<a class="hash-link" href="#parameters" title="この見出しへのリンク">​</a></h3><p>The <code>[Return]</code> and <code>[In]</code> are parameters of the grammar.</p><p>For example</p><div class="language-markdup codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-markdup codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">ScriptBody :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    StatementList[~Yield, ~Await, ~Return]</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>means top-level yield, await and return are not allowed in scripts, but</p><div class="language-markdup codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-markdup codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">ModuleItem :</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ImportDeclaration</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ExportDeclaration</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  StatementListItem[~Yield, +Await, ~Return]</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>allows for top-level await.</p><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="source-text">Source Text<a class="hash-link" href="#source-text" title="この見出しへのリンク">​</a></h2><p><a href="https://tc39.es/ecma262/#sec-types-of-source-code" target="_blank" rel="noopener noreferrer">Chapter 11.2 Types of Source Code</a> tells us that
there is a huge distinction between script code and module code.
And there is a <code>use strict</code> mode that makes the grammar saner by disallowing old JavaScript behaviors.</p><p><strong>Script Code</strong> is not strict, <code>use strict</code> need to be inserted at the top of the file to make script code strict.
In html we write <code>&lt;script src="javascript.js"&gt;&lt;/script&gt;</code>.</p><p><strong>Module Code</strong> is automatically strict.
In html we write <code>&lt;script type="module" src="main.mjs"&gt;&lt;/script&gt;</code>.</p><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="ecmascript-language-lexical-grammar">ECMAScript Language: Lexical Grammar<a class="hash-link" href="#ecmascript-language-lexical-grammar" title="この見出しへのリンク">​</a></h2><p>For more in-depth explanation, read the V8 blog on <a href="https://v8.dev/blog/understanding-ecmascript-part-3" target="_blank" rel="noopener noreferrer">Understanding the ECMAScript spec</a>.</p><h3 class="anchor anchorWithStickyNavbar_lLJQ" id="automatic-semicolon-insertion"><a href="https://tc39.es/ecma262/#sec-automatic-semicolon-insertion" target="_blank" rel="noopener noreferrer">Automatic Semicolon Insertion</a><a class="hash-link" href="#automatic-semicolon-insertion" title="この見出しへのリンク">​</a></h3><p>This section describes all the rules where we can omit a semicolon while writing JavaScript.
All the explanation boils down to</p><div class="language-rust codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-rust codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pub</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:rgb(80, 250, 123)">asi</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">&amp;</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">mut</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">eat</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token class-name">Kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token class-name">Semicolon</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">can_insert_semicolon</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> range </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">prev_node_end</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">cur_token</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">start</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token class-name">Err</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token class-name">SyntaxError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token class-name">AutoSemicolonInsertion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">range</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">into</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pub</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:rgb(80, 250, 123)">can_insert_semicolon</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">&amp;</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">bool</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">cur_token</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">is_on_new_line </span><span class="token operator">||</span><span class="token plain"> </span><span class="token macro property">matches!</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">cur_kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token class-name">Kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token class-name">RCurly</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token class-name">Kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token class-name">Eof</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>asi</code> function need to be manually called where applicable, for example in the end of statement:</p><div class="language-rust codeBlockContainer_w3Dn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_SKsd"><pre tabindex="0" class="prism-code language-rust codeBlock_I6CT thin-scrollbar"><code class="codeBlockLines_xjdV"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:rgb(80, 250, 123)">parse_debugger_statement</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">&amp;</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">mut</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Statement</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol" style="color:rgb(248, 248, 242)">'a</span><span class="token operator">&gt;&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> node </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">start_node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">expect</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token class-name">Kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token class-name">Debugger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">?</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">asi</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">?</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ast</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">debugger_statement</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">finish_node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_jTmX"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_ZTkQ" aria-hidden="true"><svg class="copyButtonIcon_ymjV" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_ZUBu" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-info alert alert--info admonition_uPsx"><div class="admonitionHeading_iLYZ"><span class="admonitionIcon_Ci8g"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>備考</div><div class="admonitionContent_zKpZ"><p>This section on asi is written with a parser in mind,
it explicitly states that the source text is parsed from left to right,
which makes it almost impossible to write the parser in any other way.
The author of jsparagus made a rant about this <a href="https://github.com/mozilla-spidermonkey/jsparagus/blob/master/js-quirks.md#automatic-semicolon-insertion-" target="_blank" rel="noopener noreferrer">here</a>.</p><blockquote><p>The specification for this feature is both very-high-level and weirdly procedural (“When, as the source text is parsed from left to right, a token is encountered...”, as if the specification is telling a story about a browser. As far as I know, this is the only place in the spec where anything is assumed or implied about the internal implementation details of parsing.) But it would be hard to specify ASI any other way.</p></blockquote></div></div><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="expressions-statements-functions-classes-scripts-and-modules">Expressions, Statements, Functions, Classes, Scripts and Modules<a class="hash-link" href="#expressions-statements-functions-classes-scripts-and-modules" title="この見出しへのリンク">​</a></h2><p>It takes a while to understand the syntactic grammar, then apply them to writing a parser.
More in-depth content can be found in <a href="/javascript-parser-in-rust/ja/blog/blog/grammar">the grammar tutorial</a>.</p><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="annex-b">Annex B<a class="hash-link" href="#annex-b" title="この見出しへのリンク">​</a></h2>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Conformance Tests]]></title>
            <link>https://boshen.github.io/javascript-parser-in-rust/ja/blog/conformance</link>
            <guid>/conformance</guid>
            <pubDate>Fri, 21 Jul 2023 06:45:25 GMT</pubDate>
            <description><![CDATA[This article details three github repositories for testing our parser against JavaScript and TypeScript grammar.]]></description>
            <content:encoded><![CDATA[<p>This article details three github repositories for testing our parser against JavaScript and TypeScript grammar.</p><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="test262">Test262<a class="hash-link" href="#test262" title="この見出しへのリンク">​</a></h2><p>JavaScript has the <a href="https://github.com/tc39/test262" target="_blank" rel="noopener noreferrer">ECMAScript Test Suite</a> called Test262.
The goal of Test262 is to provide test material that covers every observable behavior specified in the specification.</p><p>For testing conformance, please checkout its <a href="https://github.com/tc39/test262/blob/main/INTERPRETING.md#negative" target="_blank" rel="noopener noreferrer">parse phase tests</a>.</p><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="babel">Babel<a class="hash-link" href="#babel" title="この見出しへのリンク">​</a></h2><p>When new language features are added to JavaScript, it is required to have them get parsed by Babel.
So Babel has another set of <a href="https://github.com/babel/babel/tree/main/packages/babel-parser/test" target="_blank" rel="noopener noreferrer">parser tests</a>.</p><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="typescript">TypeScript<a class="hash-link" href="#typescript" title="この見出しへのリンク">​</a></h2><p>The TypeScript conformance tests can be found <a href="https://github.com/microsoft/TypeScript/tree/main/tests/cases/conformance" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_lLJQ" id="test-runner">Test Runner<a class="hash-link" href="#test-runner" title="この見出しへのリンク">​</a></h2><p>Rome has implemented a test runner for the above test suites, they can be found <a href="https://github.com/rome/tools/tree/main/xtask/coverage" target="_blank" rel="noopener noreferrer">here</a>.</p>]]></content:encoded>
        </item>
    </channel>
</rss>