<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-lexer" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.0">
<title data-rh="true">词法分析器 (Lexer) | Write a JavaScript Parser in Rust</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://oxc-project.github.io/javascript-parser-in-rust/zh/docs/lexer"><meta data-rh="true" property="og:locale" content="zh"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" property="og:locale:alternate" content="ja"><meta data-rh="true" property="og:locale:alternate" content="ko"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="keywords" content="rust, javascript, compiler, tutorial"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="词法分析器 (Lexer) | Write a JavaScript Parser in Rust"><meta data-rh="true" name="description" content="Token"><meta data-rh="true" property="og:description" content="Token"><link data-rh="true" rel="canonical" href="https://oxc-project.github.io/javascript-parser-in-rust/zh/docs/lexer"><link data-rh="true" rel="alternate" href="https://oxc-project.github.io/javascript-parser-in-rust/docs/lexer" hreflang="en"><link data-rh="true" rel="alternate" href="https://oxc-project.github.io/javascript-parser-in-rust/ja/docs/lexer" hreflang="ja"><link data-rh="true" rel="alternate" href="https://oxc-project.github.io/javascript-parser-in-rust/ko/docs/lexer" hreflang="ko"><link data-rh="true" rel="alternate" href="https://oxc-project.github.io/javascript-parser-in-rust/zh/docs/lexer" hreflang="zh"><link data-rh="true" rel="alternate" href="https://oxc-project.github.io/javascript-parser-in-rust/docs/lexer" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/javascript-parser-in-rust/zh/blog/rss.xml" title="Write a JavaScript Parser in Rust RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/javascript-parser-in-rust/zh/blog/atom.xml" title="Write a JavaScript Parser in Rust Atom Feed"><link rel="stylesheet" href="/javascript-parser-in-rust/zh/assets/css/styles.d97ac81e.css">
<script src="/javascript-parser-in-rust/zh/assets/js/runtime~main.2dfda916.js" defer="defer"></script>
<script src="/javascript-parser-in-rust/zh/assets/js/main.bb76b656.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳转到主要内容"><a class="skipToContent_NWzb" href="#__docusaurus_skipToContent_fallback">跳转到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/javascript-parser-in-rust/zh/"><b class="navbar__title text--truncate">首页</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/javascript-parser-in-rust/zh/docs/intro">指南</a><a class="navbar__item navbar__link" href="/javascript-parser-in-rust/zh/blog">教程</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_JYxa"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中文</a><ul class="dropdown__menu"><li><a href="/javascript-parser-in-rust/docs/lexer" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li><li><a href="/javascript-parser-in-rust/ja/docs/lexer" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="ja">日本語</a></li><li><a href="/javascript-parser-in-rust/ko/docs/lexer" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="ko">한국어</a></li><li><a href="/javascript-parser-in-rust/zh/docs/lexer" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh">中文</a></li></ul></div><a href="https://github.com/oxc-project/javascript-parser-in-rust" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_K0Fm"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_D6lv colorModeToggle_zcLx"><button class="clean-btn toggleButton_pcTm toggleButtonDisabled_ui1H" type="button" disabled="" title="切换暗黑模式(当前为暗黑模式)" aria-label="切换暗黑模式(当前为暗黑模式)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pSci"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_HiJo"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_cl81"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_tESK"><div class="docsWrapper_mp9g"><button aria-label="返回顶部" class="clean-btn theme-back-to-top-button backToTopButton_nN_x" type="button"></button><div class="docRoot_ghgb"><aside class="theme-doc-sidebar-container docSidebarContainer_Fu7Q"><div class="sidebarViewport_lboZ"><div class="sidebar_jzEv"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_vRuo"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/javascript-parser-in-rust/zh/docs/intro">介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/javascript-parser-in-rust/zh/docs/overview">总览</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/javascript-parser-in-rust/zh/docs/lexer">词法分析器 (Lexer)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/javascript-parser-in-rust/zh/docs/ast">抽象语法树 (Abstract Syntax Tree)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/javascript-parser-in-rust/zh/docs/parser">解析器 (Parser)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/javascript-parser-in-rust/zh/docs/errors">处理错误</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/javascript-parser-in-rust/zh/docs/semantics_analysis">语义分析 (Semantic Analysis)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/javascript-parser-in-rust/zh/docs/typescript">TypeScript</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/javascript-parser-in-rust/zh/docs/references">参考文献</a></li></ul></nav></div></div></aside><main class="docMainContainer_sAUf"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_nqJL"><div class="docItemContainer_v8iF"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_M8al" aria-label="面包屑导航"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页" class="breadcrumbs__link" href="/javascript-parser-in-rust/zh/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_NBVV"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">词法分析器 (Lexer)</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_stD2 theme-doc-toc-mobile tocMobile_FvIV"><button type="button" class="clean-btn tocCollapsibleButton_z4Su">页 面目录</button></div><div class="theme-doc-markdown markdown"><header><h1>词法分析器 (Lexer)</h1></header><h2 class="anchor anchorWithStickyNavbar_gOOc" id="token">Token<a href="#token" class="hash-link" aria-label="链接到此标题" title="链接到此标题">​</a></h2>
<p>词法分析器 (lexer)，也称为分词器 (tokenizer) 或扫描器 (scanner)，负责将源文本转换为词元 (tokens)。
这些 token 稍后将被解析器消费，因此我们不必担心原始文本中的空格和注释。</p>
<p>让我们先从简单的开始：将单个 <code>+</code> 文本转换为一个 token。</p>
<div class="language-rust codeBlockContainer_OVHg theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_Lkx3"><pre tabindex="0" class="prism-code language-rust codeBlock_uxW4 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_zxe5"><span class="token-line" style="color:#F8F8F2"><span class="token attribute attr-name" style="color:rgb(241, 250, 140)">#[derive(Debug, Clone, Copy, PartialEq)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pub</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">struct</span><span class="token plain"> </span><span class="token type-definition class-name">Token</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/// token 类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pub</span><span class="token plain"> kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">Kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/// 源文本中的起始偏移量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pub</span><span class="token plain"> start</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">usize</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/// 源文本中的结束偏移量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pub</span><span class="token plain"> end</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">usize</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token attribute attr-name" style="color:rgb(241, 250, 140)">#[derive(Debug, Clone, Copy, PartialEq)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pub</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">enum</span><span class="token plain"> </span><span class="token type-definition class-name">Kind</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">Eof</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// 文件结尾</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">Plus</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_WtSr"><button type="button" aria-label="将代码复制到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_z8Oy" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_Wj7y"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Zd0Q"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>对于单个 <code>+</code> 会输出：</p>
<div class="codeBlockContainer_OVHg theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_Lkx3"><pre tabindex="0" class="prism-code language-text codeBlock_uxW4 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_zxe5"><span class="token-line" style="color:#F8F8F2"><span class="token plain">[</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Token { kind: Kind::Plus, start: 0, end: 1 },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Token { kind: Kind::Eof,  start: 1, end: 1 }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup_WtSr"><button type="button" aria-label="将代码复制到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_z8Oy" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_Wj7y"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Zd0Q"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>为了遍历字符串，我们可以如同写 C 代码那样维护一个索引；
又或者我们可以查看 <a href="https://doc.rust-lang.org/std/primitive.str.html#" target="_blank" rel="noopener noreferrer">str 的文档</a>
并使用 <a href="https://doc.rust-lang.org/std/str/struct.Chars.html" target="_blank" rel="noopener noreferrer"><code>Chars</code></a> 迭代器。</p>
<div class="theme-admonition theme-admonition-info admonition_xR5n alert alert--info"><div class="admonitionHeading_koH8"><span class="admonitionIcon__LNr"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>备注</div><div class="admonitionContent_JMn5"><p><code>Chars</code> 迭代器抽象掉了索引的维护和边界检查等细节，让我们写代码的时候充满安全感。</p><p>当我们调用 <code>chars.next()</code> 时，它会返回 <code>Option&lt;char&gt;</code>。
但请注意，<code>char</code> 不是 0 到 255 的 ASCII 值，而是一个范围在 0 到 0x10FFFF 之间的 UTF-8 Unicode 码点值。</p></div></div>
<p>让我们定义一个初步的词法分析器抽象：</p>
<div class="language-rust codeBlockContainer_OVHg theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_Lkx3"><pre tabindex="0" class="prism-code language-rust codeBlock_uxW4 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_zxe5"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">use</span><span class="token plain"> </span><span class="token namespace">std</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token class-name">Chars</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">struct</span><span class="token plain"> </span><span class="token type-definition class-name">Lexer</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol" style="color:rgb(248, 248, 242)">&#x27;a</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/// 源文本</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    source</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol" style="color:rgb(248, 248, 242)">&#x27;a</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/// 剩余的字符</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    chars</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">Chars</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol" style="color:rgb(248, 248, 242)">&#x27;a</span><span class="token operator">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol" style="color:rgb(248, 248, 242)">&#x27;a</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token class-name">Lexer</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol" style="color:rgb(248, 248, 242)">&#x27;a</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pub</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:rgb(80, 250, 123)">new</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">source</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol" style="color:rgb(248, 248, 242)">&#x27;a</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Self</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Self</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            source</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            chars</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> source</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">chars</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_WtSr"><button type="button" aria-label="将代码复制到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_z8Oy" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_Wj7y"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Zd0Q"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-info admonition_xR5n alert alert--info"><div class="admonitionHeading_koH8"><span class="admonitionIcon__LNr"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>备注</div><div class="admonitionContent_JMn5"><p>这里的生命周期 <code>&#x27;a</code> 表示迭代器持有对某个地方的引用。在这里，它引用了一个 <code>&amp;&#x27;a str</code>。</p></div></div>
<p>要将源文本转换为 token ，只需不断调用 <code>chars.next()</code> 并对返回的 <code>char</code>进行模式匹配。
最后一个 token 将始终是 <code>Kind::Eof</code>。</p>
<div class="language-rust codeBlockContainer_OVHg theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_Lkx3"><pre tabindex="0" class="prism-code language-rust codeBlock_uxW4 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_zxe5"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol" style="color:rgb(248, 248, 242)">&#x27;a</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token class-name">Lexer</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol" style="color:rgb(248, 248, 242)">&#x27;a</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:rgb(80, 250, 123)">read_next_kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">&amp;</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">mut</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-&gt;</span><span class="token plain"> </span><span class="token class-name">Kind</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">while</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> </span><span class="token class-name">Some</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">c</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">chars</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">next</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">match</span><span class="token plain"> c </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token char" style="color:rgb(255, 121, 198)">&#x27;+&#x27;</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token class-name">Kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token class-name">Plus</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              _ </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token class-name">Kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token class-name">Eof</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:rgb(80, 250, 123)">read_next_token</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">&amp;</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">mut</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-&gt;</span><span class="token plain"> </span><span class="token class-name">Token</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> start </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">offset</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> kind </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">read_next_kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> end </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">offset</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token class-name">Token</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> start</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> end </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/// 获取从源文本中的偏移长度，以 UTF-8 字节表示</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:rgb(80, 250, 123)">offset</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">&amp;</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">usize</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">source</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">len</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">chars</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">as_str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">len</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_WtSr"><button type="button" aria-label="将代码复制到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_z8Oy" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_Wj7y"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Zd0Q"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在 <code>fn offset</code> 中，<code>.len()</code> 和 <code>.as_str().len()</code> 方法看起来像是 O(n) 的，所以让我们进一步看看是否如此。</p>
<p><a href="https://doc.rust-lang.org/src/core/str/iter.rs.html#112" target="_blank" rel="noopener noreferrer"><code>.as_str()</code></a> 返回一个指向字符串切片的指针</p>
<div class="language-rust codeBlockContainer_OVHg theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_Lkx3"><pre tabindex="0" class="prism-code language-rust codeBlock_uxW4 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_zxe5"><span class="token-line" style="color:#F8F8F2"><span class="token plain">https</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token plain">github</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">com</span><span class="token operator">/</span><span class="token plain">rust</span><span class="token operator">-</span><span class="token plain">lang</span><span class="token operator">/</span><span class="token plain">rust</span><span class="token operator">/</span><span class="token plain">blob</span><span class="token operator">/</span><span class="token plain">b998821e4c51c44a9ebee395c91323c374236bbb</span><span class="token operator">/</span><span class="token plain">library</span><span class="token operator">/</span><span class="token plain">core</span><span class="token operator">/</span><span class="token plain">src</span><span class="token operator">/</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">str</span><span class="token operator">/</span><span class="token plain">iter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">rs#</span><span class="token constant" style="color:rgb(189, 147, 249)">L112</span><span class="token operator">-</span><span class="token constant" style="color:rgb(189, 147, 249)">L115</span><br></span></code></pre><div class="buttonGroup_WtSr"><button type="button" aria-label="将代码复制到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_z8Oy" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_Wj7y"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Zd0Q"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>切片 (<a href="https://doc.rust-lang.org/std/slice/index.html" target="_blank" rel="noopener noreferrer">slice</a>)是对一块内存的视图，它通过指针和长度表示。
<code>.len()</code> 方法返回切片内部存储的元数据</p>
<div class="language-rust codeBlockContainer_OVHg theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_Lkx3"><pre tabindex="0" class="prism-code language-rust codeBlock_uxW4 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_zxe5"><span class="token-line" style="color:#F8F8F2"><span class="token plain">https</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token plain">github</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">com</span><span class="token operator">/</span><span class="token plain">rust</span><span class="token operator">-</span><span class="token plain">lang</span><span class="token operator">/</span><span class="token plain">rust</span><span class="token operator">/</span><span class="token plain">blob</span><span class="token operator">/</span><span class="token plain">b998821e4c51c44a9ebee395c91323c374236bbb</span><span class="token operator">/</span><span class="token plain">library</span><span class="token operator">/</span><span class="token plain">core</span><span class="token operator">/</span><span class="token plain">src</span><span class="token operator">/</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">str</span><span class="token operator">/</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">mod</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">rs#</span><span class="token constant" style="color:rgb(189, 147, 249)">L157</span><span class="token operator">-</span><span class="token constant" style="color:rgb(189, 147, 249)">L159</span><br></span></code></pre><div class="buttonGroup_WtSr"><button type="button" aria-label="将代码复制到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_z8Oy" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_Wj7y"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Zd0Q"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-rust codeBlockContainer_OVHg theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_Lkx3"><pre tabindex="0" class="prism-code language-rust codeBlock_uxW4 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_zxe5"><span class="token-line" style="color:#F8F8F2"><span class="token plain">https</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token plain">github</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">com</span><span class="token operator">/</span><span class="token plain">rust</span><span class="token operator">-</span><span class="token plain">lang</span><span class="token operator">/</span><span class="token plain">rust</span><span class="token operator">/</span><span class="token plain">blob</span><span class="token operator">/</span><span class="token plain">b998821e4c51c44a9ebee395c91323c374236bbb</span><span class="token operator">/</span><span class="token plain">library</span><span class="token operator">/</span><span class="token plain">core</span><span class="token operator">/</span><span class="token plain">src</span><span class="token operator">/</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">str</span><span class="token operator">/</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">mod</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">rs#</span><span class="token constant" style="color:rgb(189, 147, 249)">L323</span><span class="token operator">-</span><span class="token constant" style="color:rgb(189, 147, 249)">L325</span><br></span></code></pre><div class="buttonGroup_WtSr"><button type="button" aria-label="将代码复制到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_z8Oy" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_Wj7y"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Zd0Q"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-rust codeBlockContainer_OVHg theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_Lkx3"><pre tabindex="0" class="prism-code language-rust codeBlock_uxW4 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_zxe5"><span class="token-line" style="color:#F8F8F2"><span class="token plain">https</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token plain">github</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">com</span><span class="token operator">/</span><span class="token plain">rust</span><span class="token operator">-</span><span class="token plain">lang</span><span class="token operator">/</span><span class="token plain">rust</span><span class="token operator">/</span><span class="token plain">blob</span><span class="token operator">/</span><span class="token plain">b998821e4c51c44a9ebee395c91323c374236bbb</span><span class="token operator">/</span><span class="token plain">library</span><span class="token operator">/</span><span class="token plain">core</span><span class="token operator">/</span><span class="token plain">src</span><span class="token operator">/</span><span class="token plain">slice</span><span class="token operator">/</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">mod</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">rs#</span><span class="token constant" style="color:rgb(189, 147, 249)">L129</span><span class="token operator">-</span><span class="token constant" style="color:rgb(189, 147, 249)">L138</span><br></span></code></pre><div class="buttonGroup_WtSr"><button type="button" aria-label="将代码复制到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_z8Oy" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_Wj7y"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Zd0Q"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上面提到的这两个方法在编译之后都会成为单次数据读取，因此 <code>.as_str().len()</code> 实际上是 O(1)的。</p>
<h2 class="anchor anchorWithStickyNavbar_gOOc" id="peek">Peek<a href="#peek" class="hash-link" aria-label="链接到此标题" title="链接到此标题">​</a></h2>
<p>要对<code>++</code>或<code>+=</code>等多字符运算符进行分词，需要一个名为<code>peek</code>的辅助函数：</p>
<div class="language-rust codeBlockContainer_OVHg theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_Lkx3"><pre tabindex="0" class="prism-code language-rust codeBlock_uxW4 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_zxe5"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:rgb(80, 250, 123)">peek</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">&amp;</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-&gt;</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">char</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">chars</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">clone</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">next</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_WtSr"><button type="button" aria-label="将代码复制到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_z8Oy" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_Wj7y"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Zd0Q"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们不希望直接前移 (advance) 原始的<code>chars</code>迭代器，因此我们克隆迭代器后再前移。</p>
<div class="theme-admonition theme-admonition-info admonition_xR5n alert alert--info"><div class="admonitionHeading_koH8"><span class="admonitionIcon__LNr"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>备注</div><div class="admonitionContent_JMn5"><p>如果我们深入查看<a href="https://doc.rust-lang.org/src/core/slice/iter.rs.html#148-152" target="_blank" rel="noopener noreferrer">源代码</a>，<code>clone</code>操作是非常廉价的，它只是复制了当前索引和索引边界。</p><div class="language-rust codeBlockContainer_OVHg theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_Lkx3"><pre tabindex="0" class="prism-code language-rust codeBlock_uxW4 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_zxe5"><span class="token-line" style="color:#F8F8F2"><span class="token plain">https</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token plain">github</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">com</span><span class="token operator">/</span><span class="token plain">rust</span><span class="token operator">-</span><span class="token plain">lang</span><span class="token operator">/</span><span class="token plain">rust</span><span class="token operator">/</span><span class="token plain">blob</span><span class="token operator">/</span><span class="token plain">b998821e4c51c44a9ebee395c91323c374236bbb</span><span class="token operator">/</span><span class="token plain">library</span><span class="token operator">/</span><span class="token plain">core</span><span class="token operator">/</span><span class="token plain">src</span><span class="token operator">/</span><span class="token plain">slice</span><span class="token operator">/</span><span class="token plain">iter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">rs#</span><span class="token constant" style="color:rgb(189, 147, 249)">L148</span><span class="token operator">-</span><span class="token constant" style="color:rgb(189, 147, 249)">L152</span><br></span></code></pre><div class="buttonGroup_WtSr"><button type="button" aria-label="将代码复制到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_z8Oy" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_Wj7y"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Zd0Q"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<p><code>peek</code>和<code>chars.next()</code>的区别在于前者总是返回<strong>相同的</strong>下一个<code>char</code>，而后者会前移迭代器并返回不同的<code>char</code>。</p>
<p>举例来说，考虑字符串<code>abc</code>：</p>
<ul>
<li>重复调用<code>peek()</code>会返回<code>Some(a)</code>，<code>Some(a)</code>，<code>Some(a)</code>，...</li>
<li>重复调用<code>chars.next()</code>会返回<code>Some(&#x27;a&#x27;)</code>，<code>Some(&#x27;b&#x27;)</code>，<code>Some(&#x27;c&#x27;)</code>，<code>None</code>。</li>
</ul>
<p>有了<code>peek</code>，对<code>++</code>和<code>+=</code>进行分词只需要嵌套的if语句。</p>
<p>以下是来自<a href="https://github.com/mozilla-spidermonkey/jsparagus" target="_blank" rel="noopener noreferrer">jsparagus</a>的真实实现：</p>
<div class="language-rust codeBlockContainer_OVHg theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_Lkx3"><pre tabindex="0" class="prism-code language-rust codeBlock_uxW4 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_zxe5"><span class="token-line" style="color:#F8F8F2"><span class="token plain">https</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token plain">github</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">com</span><span class="token operator">/</span><span class="token plain">mozilla</span><span class="token operator">-</span><span class="token plain">spidermonkey</span><span class="token operator">/</span><span class="token plain">jsparagus</span><span class="token operator">/</span><span class="token plain">blob</span><span class="token operator">/</span><span class="token plain">master</span><span class="token operator">/</span><span class="token plain">crates</span><span class="token operator">/</span><span class="token plain">parser</span><span class="token operator">/</span><span class="token plain">src</span><span class="token operator">/</span><span class="token plain">lexer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">rs#</span><span class="token constant" style="color:rgb(189, 147, 249)">L1769</span><span class="token operator">-</span><span class="token constant" style="color:rgb(189, 147, 249)">L1791</span><br></span></code></pre><div class="buttonGroup_WtSr"><button type="button" aria-label="将代码复制到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_z8Oy" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_Wj7y"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Zd0Q"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上述逻辑实际上适用于所有运算符，因此让我们将学到的知识扩展到对 JavaScript 的词法分析上试试。</p>
<h2 class="anchor anchorWithStickyNavbar_gOOc" id="javascript">JavaScript<a href="#javascript" class="hash-link" aria-label="链接到此标题" title="链接到此标题">​</a></h2>
<p>用 Rust 编写的词法分析器相当无聊，感觉就像写 C 代码一样，我们写长长的 if 语句并检查每个<code>char</code>，然后返回相应的 token。</p>
<p>对 JavaScript 的词法分析才是真正有趣的部分。</p>
<p>让我们打开<a href="https://tc39.es/ecma262/" target="_blank" rel="noopener noreferrer">《ECMAScript语言规范》</a>并重新学习 JavaScript。</p>
<div class="theme-admonition theme-admonition-caution admonition_xR5n alert alert--warning"><div class="admonitionHeading_koH8"><span class="admonitionIcon__LNr"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_JMn5"><p>我仍然记得第一次打开规范时，我仅仅偷瞄了几个字就陷入痛苦、泪流满面，因为这就像是阅读到处都是术语黑话的外文文本。所以当你觉得哪里不对劲，可以去看看我的<a href="/javascript-parser-in-rust/zh/blog/ecma-spec">阅读规范指南</a>。</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_gOOc" id="注释">注释<a href="#注释" class="hash-link" aria-label="链接到此标题" title="链接到此标题">​</a></h3>
<p>注释 (comments) 没有语义意义，如果我们正在编写运行时，那可以跳过它们；但如果我们正在编写一个 linter 或 bundler，那就不可忽略。</p>
<h3 class="anchor anchorWithStickyNavbar_gOOc" id="标识符和-unicode">标识符和 Unicode<a href="#标识符和-unicode" class="hash-link" aria-label="链接到此标题" title="链接到此标题">​</a></h3>
<p>我们大多数时候使用 ASCII 编码，
但是<a href="https://tc39.es/ecma262/#sec-ecmascript-language-source-code" target="_blank" rel="noopener noreferrer">《ECMAScript语言规范: 源代码》第11章</a> 规定源代码应该使用 Unicode 编码。
而<a href="https://tc39.es/ecma262/#sec-names-and-keywords" target="_blank" rel="noopener noreferrer">第 12.6 章 名称和关键字</a>规定，标识符 (identifier) 的解释遵循 Unicode 标准附录 31 中给出的默认标识符语法 (Default Identifier Syntax)。
具体来说：</p>
<div class="language-markup codeBlockContainer_OVHg theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_Lkx3"><pre tabindex="0" class="prism-code language-markup codeBlock_uxW4 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_zxe5"><span class="token-line" style="color:#F8F8F2"><span class="token plain">IdentifierStartChar ::</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    UnicodeIDStart</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">IdentifierPartChar ::</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    UnicodeIDContinue</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">UnicodeIDStart ::</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    any Unicode code point with the Unicode property “ID_Start”</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">UnicodeIDContinue ::</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    any Unicode code point with the Unicode property “ID_Continue”</span><br></span></code></pre><div class="buttonGroup_WtSr"><button type="button" aria-label="将代码复制到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_z8Oy" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_Wj7y"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Zd0Q"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这意味着我们可以写<code>var ಠ_ಠ</code>，但不能写<code>var 🦀</code>，
<code>ಠ</code>具有Unicode属性&quot;ID_Start&quot;，而<code>🦀</code>则没有。</p>
<div class="theme-admonition theme-admonition-info admonition_xR5n alert alert--info"><div class="admonitionHeading_koH8"><span class="admonitionIcon__LNr"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>备注</div><div class="admonitionContent_JMn5"><p>我发布了 <a href="https://crates.io/crates/unicode-id-start" target="_blank" rel="noopener noreferrer">unicode-id-start</a> 这个 crate，用于这个特定目的。
我们可以调用<code>unicode_id_start::is_id_start(char)</code>和<code>unicode_id_start::is_id_continue(char)</code>来检查 Unicode 。</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_gOOc" id="关键字">关键字<a href="#关键字" class="hash-link" aria-label="链接到此标题" title="链接到此标题">​</a></h3>
<p>所有的<a href="https://tc39.es/ecma262/#sec-keywords-and-reserved-words" target="_blank" rel="noopener noreferrer">关键字</a> (keywords)，比如<code>if</code>、<code>while</code>和<code>for</code>，
都需要视作一个整体进行分词。
它们需要被添加到 token 种类的枚举中，这样我们就不必在解析器中进行字符串比较了。</p>
<div class="language-rust codeBlockContainer_OVHg theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_Lkx3"><pre tabindex="0" class="prism-code language-rust codeBlock_uxW4 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_zxe5"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pub</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">enum</span><span class="token plain"> </span><span class="token type-definition class-name">Kind</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">Identifier</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">If</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">While</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">For</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_WtSr"><button type="button" aria-label="将代码复制到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_z8Oy" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_Wj7y"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Zd0Q"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-caution admonition_xR5n alert alert--warning"><div class="admonitionHeading_koH8"><span class="admonitionIcon__LNr"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_JMn5"><p><code>undefined</code>不是一个关键字，不需要在这里添加。</p></div></div>
<p>对关键字进行分词只需匹配上述的标识符。</p>
<div class="language-rust codeBlockContainer_OVHg theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_Lkx3"><pre tabindex="0" class="prism-code language-rust codeBlock_uxW4 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_zxe5"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:rgb(80, 250, 123)">match_keyword</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">&amp;</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> ident</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-&gt;</span><span class="token plain"> </span><span class="token class-name">Kind</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 所有关键字的长度都在1到10之间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> ident</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">len</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">==</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> ident</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">len</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">10</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token class-name">Kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token class-name">Identifier</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">match</span><span class="token plain"> ident </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;if&quot;</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token class-name">Kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token class-name">If</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;while&quot;</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token class-name">Kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token class-name">While</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;for&quot;</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token class-name">Kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token class-name">For</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        _ </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token class-name">Kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token class-name">Identifier</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_WtSr"><button type="button" aria-label="将代码复制到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_z8Oy" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_Wj7y"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Zd0Q"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_gOOc" id="token-的值">Token 的值<a href="#token-的值" class="hash-link" aria-label="链接到此标题" title="链接到此标题">​</a></h3>
<p>在编译器的后续阶段，我们经常需要比较标识符、数字和字符串，
例如  在 linter 中对标识符进行测试。</p>
<p>这些值目前以源文本的形式存在。现在让我们将它们转换为 Rust 类型，以便更容易处理。</p>
<div class="language-rust codeBlockContainer_OVHg theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_Lkx3"><pre tabindex="0" class="prism-code language-rust codeBlock_uxW4 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_zxe5"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pub</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">enum</span><span class="token plain"> </span><span class="token type-definition class-name">Kind</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">Eof</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// 文件结尾</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">Plus</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">Identifier</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">Number</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token attribute attr-name" style="color:rgb(241, 250, 140)">#[derive(Debug, Clone, Copy, PartialEq)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pub</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">struct</span><span class="token plain"> </span><span class="token type-definition class-name">Token</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/// Token 类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pub</span><span class="token plain"> kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">Kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/// 在源码中的起始偏移量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pub</span><span class="token plain"> start</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">usize</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/// 在源码中的结束偏移量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pub</span><span class="token plain"> end</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">usize</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pub</span><span class="token plain"> value</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">TokenValue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token attribute attr-name" style="color:rgb(241, 250, 140)">#[derive(Debug, Clone, PartialEq)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pub</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">enum</span><span class="token plain"> </span><span class="token type-definition class-name">TokenValue</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">Number</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">f64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_WtSr"><button type="button" aria-label="将代码复制到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_z8Oy" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_Wj7y"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Zd0Q"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>当对标识符 <code>foo</code> 或字符串 <code>&quot;bar&quot;</code> 进行分词时，我们会得到:</p>
<div class="language-markup codeBlockContainer_OVHg theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_Lkx3"><pre tabindex="0" class="prism-code language-markup codeBlock_uxW4 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_zxe5"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Token { kind: Kind::Identifier, start: 0, end: 2, value: TokenValue::String(&quot;foo&quot;) }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Token { kind: Kind::String, start: 0, end: 4, value: TokenValue::String(&quot;bar&quot;) }</span><br></span></code></pre><div class="buttonGroup_WtSr"><button type="button" aria-label="将代码复制到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_z8Oy" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_Wj7y"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Zd0Q"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>要将它们转换为 Rust 字符串，先调用 <code>let s = self.source[token.start..token.end].to_string()</code>，
然后用 <code>token.value = TokenValue::String(s)</code> 保存它。</p>
<p>当我们分词一个数字 <code>1.23</code> 时，我们得到一个类似 <code>Token { start: 0, end: 3 }</code> 的 token。
要将它转换为 Rust 的 <code>f64</code>，我们可以使用字符串的 <a href="https://doc.rust-lang.org/std/primitive.str.html#method.parse" target="_blank" rel="noopener noreferrer"><code>parse</code></a> 方法，
通过调用 <code>self.source[token.start..token.end].parse::&lt;f64&gt;()</code>，然后将值保存到 <code>token.value</code> 中。
对于二进制、八进制和整数，可以在 <a href="https://github.com/mozilla-spidermonkey/jsparagus/blob/master/crates/parser/src/numeric_value.rs" target="_blank" rel="noopener noreferrer">jsparagus</a> 中找到解析它们的方法。</p>
<h2 class="anchor anchorWithStickyNavbar_gOOc" id="rust-优化">Rust 优化<a href="#rust-优化" class="hash-link" aria-label="链接到此标题" title="链接到此标题">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_gOOc" id="更小的-token">更小的 Token<a href="#更小的-token" class="hash-link" aria-label="链接到此标题" title="链接到此标题">​</a></h3>
<p>若要获得更简单安全的代码，把 token 的值放在 <code>Kind</code> 枚举的内部似乎是个非常诱人的选择：</p>
<div class="language-rust codeBlockContainer_OVHg theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_Lkx3"><pre tabindex="0" class="prism-code language-rust codeBlock_uxW4 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_zxe5"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pub</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">enum</span><span class="token plain"> </span><span class="token type-definition class-name">Kind</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">Number</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">f64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_WtSr"><button type="button" aria-label="将代码复制到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_z8Oy" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_Wj7y"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Zd0Q"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>众所周知，Rust 枚举的字节大小是其所有变体的联合 (union)。
相比原始枚举，这个枚举多了很多字节，而原始枚举只有 1 个字节。
解析器中将会大量使用 <code>Kind</code> 枚举，处理 1 个字节的枚举显然比处理多字节枚举更快。</p>
<h3 class="anchor anchorWithStickyNavbar_gOOc" id="string-interning">String Interning<a href="#string-interning" class="hash-link" aria-label="链接到此标题" title="链接到此标题">​</a></h3>
<p>在编译器中使用 <code>String</code> 性能并不高，主要是因为：</p>
<ul>
<li><code>String</code> 分配在堆上</li>
<li><code>String</code>的比较是一个 O(n) 的操作</li>
</ul>
<p><a href="https://en.wikipedia.org/wiki/String_interning" target="_blank" rel="noopener noreferrer">String Interning</a> 通过在缓存中只存储每个不同字符串值的一个副本及其唯一标识以解决这些问题。
每个不同标识符或字符串将只有一次堆分配，并且字符串比较变为 O(1)。</p>
<p>在 <a href="https://crates.io/search?q=string%20interning" target="_blank" rel="noopener noreferrer">crates.io</a> 上有许多 string interning 库，具有不同的优缺点。</p>
<p>在最开始，我们使用<a href="https://crates.io/crates/string_cache" target="_blank" rel="noopener noreferrer"><code>string-cache</code></a>便已够用，它有一个 <code>Atom</code> 类型和一个编译时的 <code>atom!(&quot;string&quot;)</code> 接口。</p>
<p>使用 <code>string-cache</code> 后，<code>TokenValue</code> 需改为：</p>
<div class="language-rust codeBlockContainer_OVHg theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_Lkx3"><pre tabindex="0" class="prism-code language-rust codeBlock_uxW4 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_zxe5"><span class="token-line" style="color:#F8F8F2"><span class="token attribute attr-name" style="color:rgb(241, 250, 140)">#[derive(Debug, Clone, PartialEq)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pub</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">enum</span><span class="token plain"> </span><span class="token type-definition class-name">TokenValue</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">Number</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">f64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token class-name">Atom</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_WtSr"><button type="button" aria-label="将代码复制到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_z8Oy" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_Wj7y"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Zd0Q"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>字符串比较则变为 <code>matches!(value, TokenValue::String(atom!(&quot;string&quot;)))</code>。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/oxc-project/javascript-parser-in-rust/tree/main/docs/lexer.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_cqCU" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页面</a></div><div class="col lastUpdated_FZ_K"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/javascript-parser-in-rust/zh/docs/overview"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">总览</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/javascript-parser-in-rust/zh/docs/ast"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">抽象语法树 (Abstract Syntax Tree)</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_TQ8G thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#token" class="table-of-contents__link toc-highlight">Token</a></li><li><a href="#peek" class="table-of-contents__link toc-highlight">Peek</a></li><li><a href="#javascript" class="table-of-contents__link toc-highlight">JavaScript</a><ul><li><a href="#注释" class="table-of-contents__link toc-highlight">注释</a></li><li><a href="#标识符和-unicode" class="table-of-contents__link toc-highlight">标识符和 Unicode</a></li><li><a href="#关键字" class="table-of-contents__link toc-highlight">关键字</a></li><li><a href="#token-的值" class="table-of-contents__link toc-highlight">Token 的值</a></li></ul></li><li><a href="#rust-优化" class="table-of-contents__link toc-highlight">Rust 优化</a><ul><li><a href="#更小的-token" class="table-of-contents__link toc-highlight">更小的 Token</a></li><li><a href="#string-interning" class="table-of-contents__link toc-highlight">String Interning</a></li></ul></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>